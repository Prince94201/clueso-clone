import"./modulepreload-polyfill-B5Qt9EMX.js";let n=null,c=[],d=null;function f(e){if(e)for(const r of e.getTracks())r.stop()}async function S(e){return await navigator.mediaDevices.getUserMedia({video:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e}},audio:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e}}})}async function p(){return await navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}function w(e){const r=e.flatMap(o=>o.getAudioTracks());if(r.length===0)return null;const a=new AudioContext,t=a.createMediaStreamDestination();for(const o of r)a.createMediaStreamSource(new MediaStream([o])).connect(t);return t.stream.getAudioTracks()[0]??null}async function g(e,r){if(n)return;c=[];const a=await S(e);let t=null;if(r)try{t=await p()}catch{t=null}const o=[],s=a.getVideoTracks()[0];s&&o.push(s);const u=w([a,...t?[t]:[]]);u&&o.push(u),d=new MediaStream(o);const l=["video/webm;codecs=vp9,opus","video/webm;codecs=vp8,opus","video/webm"].find(i=>MediaRecorder.isTypeSupported(i))??"";n=new MediaRecorder(d,l?{mimeType:l}:void 0),n.ondataavailable=i=>{i.data&&i.data.size>0&&c.push(i.data)},n.start(1e3),a.getTracks().forEach(i=>i.addEventListener("ended",()=>{m()}))}async function m(){if(!n)return null;const e=n;n=null,await new Promise(o=>{e.onstop=()=>o(),e.stop()});const r=new Blob(c,{type:"video/webm"});c=[],f(d),d=null;const a=URL.createObjectURL(r),t=`recording-${new Date().toISOString().replace(/[:.]/g,"-")}.webm`;return{url:a,filename:t}}chrome.runtime.onMessage.addListener((e,r,a)=>((async()=>{if(e?.type==="OFFSCREEN_START"){await g(e.streamId,!!e.withMic),a({ok:!0});return}if(e?.type==="OFFSCREEN_STOP"){const t=await m();a({ok:!0,result:t});return}a({ok:!1,error:"Unknown message"})})().catch(t=>a({ok:!1,error:String(t?.message??t)})),!0));
//# sourceMappingURL=offscreen.js.map
