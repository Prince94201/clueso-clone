const e={recording:!1,recordingTabId:null},g="offscreen/offscreen.html";async function h(){await chrome.offscreen.hasDocument?.()||await chrome.offscreen.createDocument({url:g,reasons:["USER_MEDIA"],justification:"Record the current tab using MediaRecorder in an offscreen document."})}async function T(r){r?await chrome.storage.local.set({authToken:r}):await chrome.storage.local.remove("authToken")}async function l(){return(await chrome.storage.local.get("authToken"))?.authToken??null}chrome.runtime.onMessage.addListener((r,b,t)=>((async()=>{if(r?.type==="AUTH_SYNC"){const a=typeof r?.token=="string"?r.token:null;a&&await T(a),t({ok:!0});return}if(r?.type==="AUTH_STATUS"){const a=await l();t({ok:!0,signedIn:!!a});return}if(r?.type==="GET_STATE"){t({recording:e.recording});return}if(r?.type==="START_RECORDING"){if(e.recording){t({ok:!0,recording:!0});return}await h();const a=await chrome.tabCapture.getMediaStreamId({targetTabId:r?.tabId});await chrome.runtime.sendMessage({type:"OFFSCREEN_START",streamId:a,withMic:!!r?.withMic}),e.recording=!0,e.recordingTabId=r?.tabId,e.recordingTabId&&chrome.tabs.sendMessage(e.recordingTabId,{type:"SHOW_CLUESO_UI"}).catch(()=>{}),t({ok:!0,recording:!0});return}if(r?.type==="STOP_RECORDING"){if(!e.recording){t({ok:!0,recording:!1}),e.recordingTabId&&(chrome.tabs.sendMessage(e.recordingTabId,{type:"HIDE_CLUESO_UI"}).catch(()=>{}),e.recordingTabId=null);return}if(r.discard){await chrome.runtime.sendMessage({type:"OFFSCREEN_STOP"}),e.recording=!1,e.recordingTabId&&(chrome.tabs.sendMessage(e.recordingTabId,{type:"HIDE_CLUESO_UI"}).catch(()=>{}),e.recordingTabId=null),t({ok:!0,recording:!1,discarded:!0});return}e.recordingTabId&&chrome.tabs.sendMessage(e.recordingTabId,{type:"UPDATE_UI",status:"uploading"}).catch(()=>{});const a=await chrome.runtime.sendMessage({type:"OFFSCREEN_STOP"});e.recording=!1;const n=a?.result;if(!n?.url){e.recordingTabId&&(chrome.tabs.sendMessage(e.recordingTabId,{type:"HIDE_CLUESO_UI"}).catch(()=>{}),e.recordingTabId=null),t({ok:!1,error:"No recording data"});return}(async()=>{try{const o=await l();if(!o)throw new Error("Not authenticated");const c=await fetch(n.url).then(f=>f.blob()),u=new File([c],n.filename,{type:"video/webm"}),d=new FormData;d.append("video",u),d.append("title","Screen Recording "+new Date().toLocaleString());const i=await fetch("http://localhost:5001/api/videos",{method:"POST",headers:{Authorization:`Bearer ${o}`},body:d});if(!i.ok)throw new Error(`Upload failed: ${i.status} ${i.statusText}`);const s=await i.json();s?.id&&chrome.tabs.create({url:`http://localhost:3000/videos/${s.id}`})}catch(o){console.error("Upload error:",o),e.recordingTabId&&chrome.tabs.sendMessage(e.recordingTabId,{type:"SHOW_ERROR",error:`Upload failed: ${o?.message?.slice(0,40)||"Unknown"}`}).catch(()=>{}),await new Promise(c=>setTimeout(c,3e3)),chrome.notifications.create({type:"basic",iconUrl:"assets/icon128.png",title:"Upload Failed",message:`Error: ${o?.message||"Unknown"}. Saving locally.`}),await chrome.downloads.download({url:n.url,filename:n.filename,saveAs:!0})}finally{e.recordingTabId&&(chrome.tabs.sendMessage(e.recordingTabId,{type:"HIDE_CLUESO_UI"}).catch(()=>{}),e.recordingTabId=null)}})(),t({ok:!0,recording:!1,uploadStarted:!0});return}t({ok:!1,error:"Unknown message"})})().catch(a=>{t({ok:!1,error:String(a?.message??a)})}),!0));
//# sourceMappingURL=background.js.map
