{"version":3,"file":"background.js","sources":["../src/background.ts"],"sourcesContent":["type RecorderState = {\n  recording: boolean;\n};\n\nconst state: RecorderState = {\n  recording: false\n};\n\nconst OFFSCREEN_URL = 'offscreen/offscreen.html';\n\nasync function ensureOffscreenDocument() {\n  // @ts-ignore - MV3 offscreen types vary by @types/chrome version\n  const existing = await chrome.offscreen.hasDocument?.();\n  if (existing) return;\n\n  // @ts-ignore - MV3 offscreen types vary by @types/chrome version\n  await chrome.offscreen.createDocument({\n    url: OFFSCREEN_URL,\n    reasons: ['USER_MEDIA'],\n    justification: 'Record the current tab using MediaRecorder in an offscreen document.'\n  });\n}\n\nasync function setAuthToken(token: string | null) {\n  if (token) {\n    await chrome.storage.local.set({ authToken: token });\n  } else {\n    await chrome.storage.local.remove('authToken');\n  }\n}\n\nasync function getAuthToken(): Promise<string | null> {\n  const res = await chrome.storage.local.get('authToken');\n  return (res?.authToken as string | undefined) ?? null;\n}\n\nchrome.runtime.onMessage.addListener((message, _sender, sendResponse) => {\n  (async () => {\n    if (message?.type === 'AUTH_SYNC') {\n      const token = typeof message?.token === 'string' ? message.token : null;\n      if (token) await setAuthToken(token);\n      sendResponse({ ok: true });\n      return;\n    }\n\n    if (message?.type === 'AUTH_STATUS') {\n      const token = await getAuthToken();\n      sendResponse({ ok: true, signedIn: Boolean(token) });\n      return;\n    }\n\n    if (message?.type === 'GET_STATE') {\n      sendResponse({ recording: state.recording });\n      return;\n    }\n\n    if (message?.type === 'START_RECORDING') {\n      if (state.recording) {\n        sendResponse({ ok: true, recording: true });\n        return;\n      }\n\n      await ensureOffscreenDocument();\n\n      const streamId = await chrome.tabCapture.getMediaStreamId({\n        targetTabId: message?.tabId\n      });\n\n      await chrome.runtime.sendMessage({\n        type: 'OFFSCREEN_START',\n        streamId,\n        withMic: Boolean(message?.withMic)\n      });\n\n      state.recording = true;\n      sendResponse({ ok: true, recording: true });\n      return;\n    }\n\n    if (message?.type === 'STOP_RECORDING') {\n      if (!state.recording) {\n        sendResponse({ ok: true, recording: false });\n        return;\n      }\n\n      const result = await chrome.runtime.sendMessage({ type: 'OFFSCREEN_STOP' });\n      state.recording = false;\n      sendResponse({ ok: true, recording: false, result });\n      return;\n    }\n\n    sendResponse({ ok: false, error: 'Unknown message' });\n  })().catch((err) => {\n    sendResponse({ ok: false, error: String(err?.message ?? err) });\n  });\n\n  return true;\n});\n"],"names":["state","OFFSCREEN_URL","ensureOffscreenDocument","setAuthToken","token","getAuthToken","message","_sender","sendResponse","streamId","result","err"],"mappings":"AAIA,MAAMA,EAAuB,CAC3B,UAAW,EACb,EAEMC,EAAgB,2BAEtB,eAAeC,GAA0B,CAEtB,MAAM,OAAO,UAAU,cAAA,GAIxC,MAAM,OAAO,UAAU,eAAe,CACpC,IAAKD,EACL,QAAS,CAAC,YAAY,EACtB,cAAe,sEAAA,CAChB,CACH,CAEA,eAAeE,EAAaC,EAAsB,CAC5CA,EACF,MAAM,OAAO,QAAQ,MAAM,IAAI,CAAE,UAAWA,EAAO,EAEnD,MAAM,OAAO,QAAQ,MAAM,OAAO,WAAW,CAEjD,CAEA,eAAeC,GAAuC,CAEpD,OADY,MAAM,OAAO,QAAQ,MAAM,IAAI,WAAW,IACzC,WAAoC,IACnD,CAEA,OAAO,QAAQ,UAAU,YAAY,CAACC,EAASC,EAASC,MACrD,SAAY,CACX,GAAIF,GAAS,OAAS,YAAa,CACjC,MAAMF,EAAQ,OAAOE,GAAS,OAAU,SAAWA,EAAQ,MAAQ,KAC/DF,GAAO,MAAMD,EAAaC,CAAK,EACnCI,EAAa,CAAE,GAAI,GAAM,EACzB,MACF,CAEA,GAAIF,GAAS,OAAS,cAAe,CACnC,MAAMF,EAAQ,MAAMC,EAAA,EACpBG,EAAa,CAAE,GAAI,GAAM,SAAU,EAAQJ,EAAQ,EACnD,MACF,CAEA,GAAIE,GAAS,OAAS,YAAa,CACjCE,EAAa,CAAE,UAAWR,EAAM,SAAA,CAAW,EAC3C,MACF,CAEA,GAAIM,GAAS,OAAS,kBAAmB,CACvC,GAAIN,EAAM,UAAW,CACnBQ,EAAa,CAAE,GAAI,GAAM,UAAW,GAAM,EAC1C,MACF,CAEA,MAAMN,EAAA,EAEN,MAAMO,EAAW,MAAM,OAAO,WAAW,iBAAiB,CACxD,YAAaH,GAAS,KAAA,CACvB,EAED,MAAM,OAAO,QAAQ,YAAY,CAC/B,KAAM,kBACN,SAAAG,EACA,QAAS,EAAQH,GAAS,OAAO,CAClC,EAEDN,EAAM,UAAY,GAClBQ,EAAa,CAAE,GAAI,GAAM,UAAW,GAAM,EAC1C,MACF,CAEA,GAAIF,GAAS,OAAS,iBAAkB,CACtC,GAAI,CAACN,EAAM,UAAW,CACpBQ,EAAa,CAAE,GAAI,GAAM,UAAW,GAAO,EAC3C,MACF,CAEA,MAAME,EAAS,MAAM,OAAO,QAAQ,YAAY,CAAE,KAAM,iBAAkB,EAC1EV,EAAM,UAAY,GAClBQ,EAAa,CAAE,GAAI,GAAM,UAAW,GAAO,OAAAE,EAAQ,EACnD,MACF,CAEAF,EAAa,CAAE,GAAI,GAAO,MAAO,kBAAmB,CACtD,GAAA,EAAK,MAAOG,GAAQ,CAClBH,EAAa,CAAE,GAAI,GAAO,MAAO,OAAOG,GAAK,SAAWA,CAAG,EAAG,CAChE,CAAC,EAEM,GACR"}