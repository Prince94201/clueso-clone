{"version":3,"file":"background.js","sources":["../src/background.ts"],"sourcesContent":["type RecorderState = {\n  recording: boolean;\n  recordingTabId: number | null;\n};\n\nconst state: RecorderState = {\n  recording: false,\n  recordingTabId: null\n};\n\nconst OFFSCREEN_URL = 'offscreen/offscreen.html';\n\nasync function ensureOffscreenDocument() {\n  // @ts-ignore - MV3 offscreen types vary by @types/chrome version\n  const existing = await chrome.offscreen.hasDocument?.();\n  if (existing) return;\n\n  // @ts-ignore - MV3 offscreen types vary by @types/chrome version\n  await chrome.offscreen.createDocument({\n    url: OFFSCREEN_URL,\n    reasons: ['USER_MEDIA'],\n    justification: 'Record the current tab using MediaRecorder in an offscreen document.'\n  });\n}\n\nasync function setAuthToken(token: string | null) {\n  if (token) {\n    await chrome.storage.local.set({ authToken: token });\n  } else {\n    await chrome.storage.local.remove('authToken');\n  }\n}\n\nasync function getAuthToken(): Promise<string | null> {\n  const res = await chrome.storage.local.get('authToken');\n  return (res?.authToken as string | undefined) ?? null;\n}\n\nchrome.runtime.onMessage.addListener((message, _sender, sendResponse) => {\n  (async () => {\n    if (message?.type === 'AUTH_SYNC') {\n      const token = typeof message?.token === 'string' ? message.token : null;\n      if (token) await setAuthToken(token);\n      sendResponse({ ok: true });\n      return;\n    }\n\n    if (message?.type === 'AUTH_STATUS') {\n      const token = await getAuthToken();\n      sendResponse({ ok: true, signedIn: Boolean(token) });\n      return;\n    }\n\n    if (message?.type === 'GET_STATE') {\n      sendResponse({ recording: state.recording });\n      return;\n    }\n\n    if (message?.type === 'START_RECORDING') {\n      if (state.recording) {\n        sendResponse({ ok: true, recording: true });\n        return;\n      }\n\n      await ensureOffscreenDocument();\n\n      const streamId = await chrome.tabCapture.getMediaStreamId({\n        targetTabId: message?.tabId\n      });\n\n      await chrome.runtime.sendMessage({\n        type: 'OFFSCREEN_START',\n        streamId,\n        withMic: Boolean(message?.withMic)\n      });\n\n      state.recording = true;\n      state.recordingTabId = message?.tabId;\n\n      // Show the floating UI on the recording tab\n      if (state.recordingTabId) {\n        chrome.tabs.sendMessage(state.recordingTabId, { type: 'SHOW_CLUESO_UI' }).catch(() => { });\n      }\n\n      sendResponse({ ok: true, recording: true });\n      return;\n    }\n\n    if (message?.type === 'STOP_RECORDING') {\n      if (!state.recording) {\n        sendResponse({ ok: true, recording: false });\n        // Ensure UI is hidden even if we thought we weren't recording\n        if (state.recordingTabId) {\n          chrome.tabs.sendMessage(state.recordingTabId, { type: 'HIDE_CLUESO_UI' }).catch(() => { });\n          state.recordingTabId = null;\n        }\n        return;\n      }\n\n      // If discard is requested, stop and cleanup without upload\n      if (message.discard) {\n        await chrome.runtime.sendMessage({ type: 'OFFSCREEN_STOP' });\n        state.recording = false;\n        if (state.recordingTabId) {\n          chrome.tabs.sendMessage(state.recordingTabId, { type: 'HIDE_CLUESO_UI' }).catch(() => { });\n          state.recordingTabId = null;\n        }\n        sendResponse({ ok: true, recording: false, discarded: true });\n        return;\n      }\n\n      // 1. Notify UI: Uploading\n      if (state.recordingTabId) {\n        chrome.tabs.sendMessage(state.recordingTabId, { type: 'UPDATE_UI', status: 'uploading' }).catch(() => { });\n      }\n\n      // 2. Stop recording to get blob\n      const result = await chrome.runtime.sendMessage({ type: 'OFFSCREEN_STOP' });\n      state.recording = false;\n      const resData = result?.result;\n\n      if (!resData?.url) {\n        // Error case\n        if (state.recordingTabId) {\n          chrome.tabs.sendMessage(state.recordingTabId, { type: 'HIDE_CLUESO_UI' }).catch(() => { });\n          state.recordingTabId = null;\n        }\n        sendResponse({ ok: false, error: 'No recording data' });\n        return;\n      }\n\n      // 3. Upload process\n      (async () => {\n        try {\n          const token = await getAuthToken();\n          if (!token) throw new Error('Not authenticated');\n\n          const blob = await fetch(resData.url).then(r => r.blob());\n          const file = new File([blob], resData.filename, { type: 'video/webm' });\n\n          const formData = new FormData();\n          formData.append('video', file);\n          formData.append('title', 'Screen Recording ' + new Date().toLocaleString());\n\n          // Server likely on 5001 to avoid AirPlay conflict (default in client lib)\n          const uploadRes = await fetch('http://localhost:5001/api/videos', {\n            method: 'POST',\n            headers: {\n              'Authorization': `Bearer ${token}`\n            },\n            body: formData\n          });\n\n          if (!uploadRes.ok) throw new Error(`Upload failed: ${uploadRes.status} ${uploadRes.statusText}`);\n\n          const video = await uploadRes.json();\n\n          // 4. Success: Redirect to video page\n          if (video?.id) {\n            chrome.tabs.create({ url: `http://localhost:3000/videos/${video.id}` });\n          }\n        } catch (err: any) {\n          console.error('Upload error:', err);\n\n          if (state.recordingTabId) {\n            chrome.tabs.sendMessage(state.recordingTabId, {\n              type: 'SHOW_ERROR',\n              error: `Upload failed: ${err?.message?.slice(0, 40) || 'Unknown'}`\n            }).catch(() => { });\n          }\n\n          // Wait a bit for user to see error\n          await new Promise(r => setTimeout(r, 3000));\n\n          chrome.notifications.create({\n            type: 'basic',\n            iconUrl: 'assets/icon128.png',\n            title: 'Upload Failed',\n            message: `Error: ${err?.message || 'Unknown'}. Saving locally.`\n          });\n\n          // Fallback: download if upload fails so user doesn't lose data\n          await chrome.downloads.download({\n            url: resData.url,\n            filename: resData.filename,\n            saveAs: true\n          });\n        } finally {\n          // 5. Cleanup UI\n          if (state.recordingTabId) {\n            chrome.tabs.sendMessage(state.recordingTabId, { type: 'HIDE_CLUESO_UI' }).catch(() => { });\n            state.recordingTabId = null;\n          }\n        }\n      })();\n\n      sendResponse({ ok: true, recording: false, uploadStarted: true });\n      return;\n    }\n\n    sendResponse({ ok: false, error: 'Unknown message' });\n  })().catch((err) => {\n    sendResponse({ ok: false, error: String(err?.message ?? err) });\n  });\n\n  return true;\n});\n"],"names":["state","OFFSCREEN_URL","ensureOffscreenDocument","setAuthToken","token","getAuthToken","message","_sender","sendResponse","streamId","result","resData","blob","r","file","formData","uploadRes","video","err"],"mappings":"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"}